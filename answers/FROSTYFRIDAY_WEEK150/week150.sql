--❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄--
--                    ,                                                                                                                                           --
--                 `^!J"^                                                                                                                                         --
--                  -JLJ.                     ...........`  `...,^^-.       ./i)?/.       `,riv~`  /iiiiiiiiiii*  `'!     ::'.                                    --
--                  .'^`.                    'BBBBBBBBBBB^ GNBBBBBBBBO"   .ABBBBHBBo.   "GBBBBBBBt BBBBBBBBBBBBB'EmBB1   "BNk].                                   --
--                  !49S:                    <BBBBBBBBNPt`.NBBBB6(5BBBN'  gBBBm=GBBBm  ^BBBBjiBBBB-B6MNNBBBB)))i`"BBBN' .MBBB!                                    --
--                :e99999x.                  vBBB&.       .BBBB   *BBBN, &BBBM  `GBBB  @BBBB=.KOOO.::- RBBBB      *BBBN:RNBBi                                     --
--              `=999999999+                 7BB&@!!!!!!  .BNBN!+c$BBBj "BBBB"   BBBB  >BBBBB8r'       RBBBB       #BBBQBBB5                                      --
--             "4999999999994_               uBBBBBBBBB0  :BBBBBBBBBNr  +BBBB"  !RBXN   "GNBBBRBo`     RBBBp        MBBBBEG                                       --
--           'u999999999999999L'             &BBBNpEUux|  ?BBBB&BBBBo   =BQBB"  SXu&m     `r4BBBNQ     qBBB4        +BBBRR,                                       --
--          !9999999999999999995+            BBBBP        NBBB^ !RBBBG  :BBBB4<7BBNR!  tY*- `BBqBB     ~BBB<         BBBp!              ,.              -`        --
--          `:t999999999999999/'             BNBBP        BBBB^  ~MBBR5  ;@BGBBGBqP"  vBBBBBBBBBQ;    .-BBB<         BBBO-            _oooe7;       '/{ooe^       --
--          ,y999999999999999993'            4A44L        4444,   ^4t`     *A444z!     .vn4444u?      .2444"        `4444-            L4A444Ay_   `=eA4444A       --
--        `?%99999999999999999999|                                                                                                    _*Pi+^"!C1 "uF!!/*kT"       --
--       !S99999999999999999999999S"          __________~    `'~___~       !!=/!      .__^^_.          :_^_.      `~'     ~__'      .'''-_+/vtl7>)lJv|="~,--.     --
--       "=Y999999999999999999999i+!         vBBB@BBBBBBB .NBBBBNBBBBS     JRBBN    @BBBBBMBBH=       zBBBBB/    RHBB-   rNjaG     `""""""l{<";;""!!iA2|/////     --
--        !P999999999999999999999A"          iBBBBBBNMRRG .BBBBMRqMBBBR    4BBBE    BBBBNMNBB&B!     |BBBBBRM`   tBBB@` _NBBB_      ^"""""l["""""////A2|//r/!     --
--       l999999999999999999999999Pr         nBBME```     ,BBBH   YBBBQ   |ABBB`   !$BBG`  RRBB@    ^BBBRBBBBv    EBBB2~BNBB"        ;!+++l[!!!""r<<<A2?>>1"      --
--     -P999999999999999999999999999[.       &BBBA*****'  1BNB!_*uBBBB<   AlBBB    ARBBS   vONBB   -NBBNekBBBB    .MBBBNBBB7         ^""""l["""!=<r//A2|///"      --
--     "eoSP9999999999999999999%w4eeu^       BBBBBBBBBB2  @BBBBBBRMBg!    S6BNR    ABBB4   N@6BA   mBBR6~;B@kB!    !BBB@BG4          ^""""l["""""////A2>///"      --
--               `.'*999L++;.                BBBBBBkAAA!  BBBBBBBBBBv     4BBRK    ABBB*  lBNBB^  cBBBNBBBBBBBT     3BBBgH`          ^""""l["""""////A2>///"      --
--                  "999"                    NBBB         BBBB^ )BBBB<    XBBNM    ABBBDegBBBB!   RBBRNBBBBBpQN      BBBa'           _""""l]"""""////A2>///"      --
--                  _999^                   `BBBB        `BBBB^  *BBBB"   XBBRR    6&BBBBBBB2.   UBBGBi_''EBe^B!    ^BBBG'           _""""l]"""""////A2>///"      --
--                  ~999^                   `RRRR        -uuuu'   =5?.    oRRR$    6mRRO2z*`    .gRRRk    _RRRRA    !RRR@'            `''-!i"""""////Y/;_:'       --
--                  `~__`                                                                                                                     ``...               --
--                                                                                                                                                                --
--❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄--

-- このチャレンジの詳細
-- [Week 150 - Intermediate](https://frostyfriday.org/blog/2025/10/10/week-150-intermediate/)

-- このチャレンジに関連するドキュメント
-- [AI_SIMILARITY](https://docs.snowflake.com/ja/sql-reference/functions/ai_similarity)
-- [AI_COMPLETE](https://docs.snowflake.com/ja/en/sql-reference/functions/ai_complete)

-- データベースとスキーマを選択
USE DATABASE FROSTYFRIDAY_DB;
USE SCHEMA WEEK150;

-- 提供されたコード
-- 一部スキーマなどを修正する
-- CREATE OR REPLACE SCHEMA FROSTYFRIDAY_DB.WEEK150;
CREATE OR REPLACE TABLE HEADERS_SAMPLE (
    COMPANY STRING,
    DOC_ID STRING,
    HEADER_ORDER INTEGER,
    HEADER_TEXT STRING
);
INSERT INTO HEADERS_SAMPLE (COMPANY, DOC_ID, HEADER_ORDER, HEADER_TEXT) VALUES
-- Company A
('AIG', 'A1', 1, '1. Coverage Overview'),
('AIG', 'A1', 2, '1.1 Policy Benefits'),
('AIG', 'A1', 3, '2. Exclusions & Limitations'),
('AIG', 'A1', 4, '3. Claims Process'),
-- Company B (variants)
('Zurich', 'Z1', 1, 'Coverage - Overview'),
('Zurich', 'Z1', 2, 'Policy Benefit(s)'),
('Zurich', 'Z1', 3, 'Exclusions and Limitations'),
('Zurich', 'Z1', 4, 'Claims – Process'),
-- Company C (more variants)
('Allianz', 'AL1', 1, '01) COVERAGE OVERVIEW'),
('Allianz', 'AL1', 2, 'Policy: Benefits'),
('Allianz', 'AL1', 3, 'Exclusions / Limitations'),
('Allianz', 'AL1', 4, 'Claims Processing'),
-- Company D (edge cases)
('AXA', 'AX1', 1, 'Coverage overview & scope'),
('AXA', 'AX1', 2, 'Benefit of Policy'),
('AXA', 'AX1', 3, 'Limitations and Exclusions'),
('AXA', 'AX1', 4, 'Filing a Claim');
SELECT * FROM HEADERS_SAMPLE ORDER BY COMPANY, DOC_ID, HEADER_ORDER;

-- 各行にIDを付与する
SELECT
    *,
    ROW_NUMBER() OVER (ORDER BY COMPANY) AS ROW_NUM,
FROM HEADERS_SAMPLE
-- JOINする
->>
SELECT
    *
FROM (
    SELECT
        A.COMPANY,
        A.DOC_ID,
        A.HEADER_ORDER,
        A.HEADER_TEXT,
        A.ROW_NUM,
        B.HEADER_TEXT AS REF_HEADER_TEXT,
        B.ROW_NUM AS REF_ROW_NUM,
    FROM $1 AS A
    LEFT OUTER JOIN $1 AS B
)
-- HEADER_TEXT同士の類似度スコアを計算して、0.80以上のものだけを残す
->>
SELECT
    *,
    AI_SIMILARITY(HEADER_TEXT, REF_HEADER_TEXT) AS SIMILARITY,
FROM $1
WHERE
    SIMILARITY > 0.80
-- 各HEADER_TEXTについて、紐づいたもののうち、一番若いIDをそのHEADER_TEXTが所属するクラスタのIDということにする
->>
SELECT
    MIN(COMPANY) AS COMPANY,
    MIN(DOC_ID) AS DOC_ID,
    MIN(HEADER_ORDER) AS HEADER_ORDER,
    MIN(HEADER_TEXT) AS HEADER_TEXT,
    MIN(REF_ROW_NUM) AS CLUSTER_ID,
FROM $1
GROUP BY HEADER_TEXT
ORDER BY COMPANY, HEADER_ORDER
-- CLUSTER_IDごとの代表テキストを抽出するためのプロンプトを生成
->>
SELECT
    CLUSTER_ID,
    CONCAT(
        'Generate a crisp canonical label from the text listed below.',
        'The crisp canonical label consists 3–5 words, no numbering or punctuation.',
        'You should not output quotation marks or similar characters.',
        'You must output only the label.',
        'list: "',
        ARRAY_TO_STRING(ARRAY_AGG(HEADER_TEXT), '", "'),
        '"'
    ) AS PROMPT
FROM $1
GROUP BY CLUSTER_ID
-- 生成したプロンプトでAI_COMPLETEを呼び出す
->>
SELECT
    CLUSTER_ID,
    AI_COMPLETE('snowflake-arctic', PROMPT)::STRING AS GENERATED_HEADER,
FROM $1
-- Snowflake Arcticは先頭に半角スペースを入れがちな性格なので、正規表現で切り出す
->>
SELECT
    CLUSTER_ID,
    GENERATED_HEADER,
    REGEXP_SUBSTR(GENERATED_HEADER, '\\s*(.*)', 1, 1, 'e') AS NORMALIZED_HEADER,
FROM $1
-- 結合して、完了！
->>
SELECT
    A.COMPANY,
    A.HEADER_TEXT AS ORIGINAL_HEADER,
    B.NORMALIZED_HEADER
FROM $4 AS A
INNER JOIN $1 AS B
ON A.CLUSTER_ID = B.CLUSTER_ID
;