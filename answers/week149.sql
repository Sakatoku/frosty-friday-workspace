--❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄--
--                    ,                                                                                                                                           --
--                 `^!J"^                                                                                                                                         --
--                  -JLJ.                     ...........`  `...,^^-.       ./i)?/.       `,riv~`  /iiiiiiiiiii*  `'!     ::'.                                    --
--                  .'^`.                    'BBBBBBBBBBB^ GNBBBBBBBBO"   .ABBBBHBBo.   "GBBBBBBBt BBBBBBBBBBBBB'EmBB1   "BNk].                                   --
--                  !49S:                    <BBBBBBBBNPt`.NBBBB6(5BBBN'  gBBBm=GBBBm  ^BBBBjiBBBB-B6MNNBBBB)))i`"BBBN' .MBBB!                                    --
--                :e99999x.                  vBBB&.       .BBBB   *BBBN, &BBBM  `GBBB  @BBBB=.KOOO.::- RBBBB      *BBBN:RNBBi                                     --
--              `=999999999+                 7BB&@!!!!!!  .BNBN!+c$BBBj "BBBB"   BBBB  >BBBBB8r'       RBBBB       #BBBQBBB5                                      --
--             "4999999999994_               uBBBBBBBBB0  :BBBBBBBBBNr  +BBBB"  !RBXN   "GNBBBRBo`     RBBBp        MBBBBEG                                       --
--           'u999999999999999L'             &BBBNpEUux|  ?BBBB&BBBBo   =BQBB"  SXu&m     `r4BBBNQ     qBBB4        +BBBRR,                                       --
--          !9999999999999999995+            BBBBP        NBBB^ !RBBBG  :BBBB4<7BBNR!  tY*- `BBqBB     ~BBB<         BBBp!              ,.              -`        --
--          `:t999999999999999/'             BNBBP        BBBB^  ~MBBR5  ;@BGBBGBqP"  vBBBBBBBBBQ;    .-BBB<         BBBO-            _oooe7;       '/{ooe^       --
--          ,y999999999999999993'            4A44L        4444,   ^4t`     *A444z!     .vn4444u?      .2444"        `4444-            L4A444Ay_   `=eA4444A       --
--        `?%99999999999999999999|                                                                                                    _*Pi+^"!C1 "uF!!/*kT"       --
--       !S99999999999999999999999S"          __________~    `'~___~       !!=/!      .__^^_.          :_^_.      `~'     ~__'      .'''-_+/vtl7>)lJv|="~,--.     --
--       "=Y999999999999999999999i+!         vBBB@BBBBBBB .NBBBBNBBBBS     JRBBN    @BBBBBMBBH=       zBBBBB/    RHBB-   rNjaG     `""""""l{<";;""!!iA2|/////     --
--        !P999999999999999999999A"          iBBBBBBNMRRG .BBBBMRqMBBBR    4BBBE    BBBBNMNBB&B!     |BBBBBRM`   tBBB@` _NBBB_      ^"""""l["""""////A2|//r/!     --
--       l999999999999999999999999Pr         nBBME```     ,BBBH   YBBBQ   |ABBB`   !$BBG`  RRBB@    ^BBBRBBBBv    EBBB2~BNBB"        ;!+++l[!!!""r<<<A2?>>1"      --
--     -P999999999999999999999999999[.       &BBBA*****'  1BNB!_*uBBBB<   AlBBB    ARBBS   vONBB   -NBBNekBBBB    .MBBBNBBB7         ^""""l["""!=<r//A2|///"      --
--     "eoSP9999999999999999999%w4eeu^       BBBBBBBBBB2  @BBBBBBRMBg!    S6BNR    ABBB4   N@6BA   mBBR6~;B@kB!    !BBB@BG4          ^""""l["""""////A2>///"      --
--               `.'*999L++;.                BBBBBBkAAA!  BBBBBBBBBBv     4BBRK    ABBB*  lBNBB^  cBBBNBBBBBBBT     3BBBgH`          ^""""l["""""////A2>///"      --
--                  "999"                    NBBB         BBBB^ )BBBB<    XBBNM    ABBBDegBBBB!   RBBRNBBBBBpQN      BBBa'           _""""l]"""""////A2>///"      --
--                  _999^                   `BBBB        `BBBB^  *BBBB"   XBBRR    6&BBBBBBB2.   UBBGBi_''EBe^B!    ^BBBG'           _""""l]"""""////A2>///"      --
--                  ~999^                   `RRRR        -uuuu'   =5?.    oRRR$    6mRRO2z*`    .gRRRk    _RRRRA    !RRR@'            `''-!i"""""////Y/;_:'       --
--                  `~__`                                                                                                                     ``...               --
--                                                                                                                                                                --
--❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄❄--

-- このチャレンジに関連するドキュメント
-- [パイプ演算子(Flow operators)](https://docs.snowflake.com/en/sql-reference/operators-flow)
-- [LATERAL FLATTEN](https://docs.snowflake.com/ja/sql-reference/functions/flatten)

-- データベースとスキーマを選択
USE DATABASE FROSTYFRIDAY_DB;
USE SCHEMA WEEK149;

-- 提供されたコード(データ生成プロシージャ)
CREATE OR REPLACE PROCEDURE gen_timeseries(start_date DATE, days INTEGER, category STRING, seed INTEGER)
RETURNS VARIANT
LANGUAGE PYTHON
RUNTIME_VERSION = '3.10'
PACKAGES = ('snowflake-snowpark-python', 'numpy')
HANDLER = 'run'
AS
$$
import numpy as np
import datetime

def run(session, start_date, days, category, seed):
    # Make the RNG deterministic for reproducibility
    rng = np.random.default_rng(int(seed) if seed is not None else 42)

    base = datetime.date.fromisoformat(str(start_date))
    rows = []

    # Start at 100 and add small Gaussian noise each day
    value = 100.0
    for i in range(int(days)):
        day = base + datetime.timedelta(days=i)
        value = max(0.0, value + float(rng.normal(0, 3)))  # keep non-negative
        rows.append({
            "date": str(day),
            "category": category,
            "value": round(value, 2)
        })

    # Compute a 3-day trailing moving average
    for i, r in enumerate(rows):
        window = rows[max(0, i-2):i+1]
        ma = sum(x["value"] for x in window) / len(window)
        r["moving_avg"] = round(ma, 2)
        r["day_index"] = i + 1

    return {
        "meta": {
            "start_date": str(base),
            "days": int(days),
            "category": category
        },
        "rows": rows
    }
$$;

-- 上記のデータ生成プロシージャの実行例
CALL gen_timeseries('2025-04-01'::DATE, 7, 'WIDGETS', 123);
-- 以下のJSONが実行結果
-- {
--   "meta": {
--     "category": "WIDGETS",
--     "days": 7,
--     "start_date": "2025-04-01"
--   },
--   "rows": [
--     {
--       "category": "WIDGETS",
--       "date": "2025-04-01",
--       "day_index": 1,
--       "moving_avg": 9.703000000000000e+01,
--       "value": 9.703000000000000e+01
--     },
--     {
--       "category": "WIDGETS",
--       "date": "2025-04-02",
--       "day_index": 2,
--       "moving_avg": 9.648000000000000e+01,
--       "value": 9.593000000000001e+01
--     },
--     {
--       "category": "WIDGETS",
--       "date": "2025-04-03",
--       "day_index": 3,
--       "moving_avg": 9.758000000000000e+01,
--       "value": 9.979000000000001e+01
--     },
--     {
--       "category": "WIDGETS",
--       "date": "2025-04-04",
--       "day_index": 4,
--       "moving_avg": 9.870000000000000e+01,
--       "value": 1.003700000000000e+02
--     },
--     {
--       "category": "WIDGETS",
--       "date": "2025-04-05",
--       "day_index": 5,
--       "moving_avg": 1.011000000000000e+02,
--       "value": 1.031400000000000e+02
--     },
--     {
--       "category": "WIDGETS",
--       "date": "2025-04-06",
--       "day_index": 6,
--       "moving_avg": 1.027900000000000e+02,
--       "value": 1.048700000000000e+02
--     },
--     {
--       "category": "WIDGETS",
--       "date": "2025-04-07",
--       "day_index": 7,
--       "moving_avg": 1.036600000000000e+02,
--       "value": 1.029600000000000e+02
--     }
--   ]
-- }

-- 求められている出力例は上記のデータ生成プロシージャをLATERAL FLATTENして構造化しただけと考えてよい
-- TS_DATE
-- CATEGORY
-- VALUE
-- MOVING_AVG
-- DAY_INDEX

-- 解法
-- パイプ演算子の後のクエリで前の実行結果を参照するためには${数値}を使う
-- LATERAL FLATTENによる半構造化データの読み取りについてf.valueまではほぼ定型。f.value:{キー}::{型}
CALL gen_timeseries('2025-04-01'::DATE, 7, 'WIDGETS', 123)
->> SELECT
        f.value:date::date AS TS_DATE,
        f.value:category::STRING AS CATEGORY,
        f.value:value::FLOAT AS VALUE,
        f.value:moving_avg::FLOAT AS MOVING_AVG,
        f.value:day_index::INTEGER AS DAY_INDEX
    FROM $1, LATERAL FLATTEN(INPUT => $1, PATH => 'rows') f
    ORDER BY DAY_INDEX;

-- 昔ながらの記法だと例えば以下のようにする。ストアドプロシージャの実行結果をRESULT_SCAN()するのが面倒…
CALL gen_timeseries('2025-04-01'::DATE, 7, 'WIDGETS', 123);
WITH
PROC_RESULT (GEN_TIMESERIES) AS (
  SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))
)
SELECT
    f.value:date::date AS TS_DATE,
    f.value:category::STRING AS CATEGORY,
    f.value:value::FLOAT AS VALUE,
    f.value:moving_avg::FLOAT AS MOVING_AVG,
    f.value:day_index::INTEGER AS DAY_INDEX
FROM PROC_RESULT, LATERAL FLATTEN(INPUT => PROC_RESULT.GEN_TIMESERIES, PATH => 'rows') f
ORDER BY DAY_INDEX;
